var _=require("underscore"),connection=require("./connection"),collection=require("./collection"),helper=require("./helper"),model={connection:connection,set:function(a,b){var c,d;if(null===a||void 0===a)return this;_.isObject(a)?d=a:(d={})[a]=b;for(c in d)c&&(this.attributes[c]=_.isUndefined(d[c])?this.schema.get(c).getDefaultValue():d[c]);return this},get:function(a){return this.attributes[a]},getHash:function(){var a=this;return _.map(a.schema.hashKeyAttributes,function(b){return a.get(b)})},getRange:function(){var a=
this;return _.map(a.schema.rangeKeyAttributes,function(b){return a.get(b)})},toJSON:function(){var a=this.schema,b={},c=_.clone(this.attributes);_.each(c,function(c,e){var f=a.get(e).toJSON(c);f&&(b[e]=f)});return b},serialize:function(){var a=this.schema,b={},c=_.clone(this.attributes);1<a.hashKeyAttributes.length&&(_.each(a.hashKeyAttributes,function(a){delete c[a]}),b[a.hashKey]=a.serializeHashAttribute(this.getHash()));_.isArray(a.rangeKeyAttributes)&&1<a.rangeKeyAttributes.length&&(_.each(a.rangeKeyAttributes,
function(a){delete c[a]}),b[a.rangeKey]=a.serializeRangeAttribute(this.getRange()));_.each(c,function(c,e){var f=a.get(e).serializeObject(c);f&&(b[e]=f)});return b},save:function(a){try{_.isFunction(a)||(a=function(){}),this.connection.client.putItem({TableName:this.schema.table,Item:this.serialize(),ReturnConsumedCapacity:"TOTAL"},function(b,d){return b?a(b):a(b,d.ConsumedCapacity.CapacityUnits)})}catch(b){return a(b)}},destroy:function(a){_.isFunction(a)||(a=function(){});var b=this.schema,c={};
try{c[b.hashKey]=this.getHash().join(b.keyDelimiter),b.hasRangeAttributes()&&(c[b.rangeKey]=this.getRange()[0])}catch(d){return a(d)}this.Model.destroy(c,a)}},Model={connection:connection,create:function(a){a=a||{};var b={schema:this.schema,connection:this.connection,attributes:{},Model:this},c="options schema connection client attributes Model".split(" ");_.each(this.options,function(a,e){0<=c.indexOf(e)||(b[e]=a)});_.each(this.schema.attributes,function(b,c){a[c]=a[c]});return _.bindAll(Object.create(model,
helper.ownProperties(b)).set(a))},findOne:function(a,b){_.isFunction(b)||(b=function(){});_.isEmpty(a)&&b(Error("You must specify match attributes"));var c=this,d=c.schema,e;if(!d.hasRangeAttributes()&&a[d.hashKey])return e={TableName:d.table,ReturnConsumedCapacity:"TOTAL",ConsistentRead:!0,Key:{}},e.Key[d.hashKey]=d.serializeHashAttribute(d.getHashFromMatch(a)),c.connection.client.getItem(e,function(a,d){if(a)return b(a);b(null,c.parse(d.Item),d.ConsumedCapacity.CapacityUnits)});c.find({match:a},
function(a,d,e){if(_.isNumber(a.statusCode)&&200!=a.statusCode)return c.protectedCallback(b,a);if(1>d.models.length)return b(Error("Item does not exist"));if(1<d.models.length)return b(Error("You must specify range or secondary attributes"));c.protectedCallback(b,null,d.models[0],e)})},find:function(a,b){_.isFunction(b)||(b=function(){});var c=this,d=c.schema,e;try{e=d.generateQueryParams(a.match);if(_.isString(a.sortBy)){if(0>d.secondaryKeyAttributes.indexOf(a.sortBy))throw Error("You can only sort by Secondary attributes");
e.IndexName=d.table+"."+a.sortBy}_.isNumber(a.take)&&(e.Limit=a.take);_.isNumber(a.skip)&&e.Limit&&(e.Limit+=a.skip)}catch(f){return b(f)}c.connection.client.query(e,function(d,e){if(_.isNumber(d.statusCode)&&200!=d.statusCode)return c.protectedCallback(b,d,e);if(e.Items&&_.isNumber(a.skip))try{e.Items=e.Items.slice(a.skip)}catch(f){return c.protectedCallback(b,f)}return c.protectedCallback(b,d,collection(_.map(e.Items,c.parse,c)),e.ConsumedCapacity.CapacityUnits)})},protectedCallback:function(a,
b,c,d){try{return a(b,c,d)}catch(e){console.error(e)}},destroy:function(a,b){_.isFunction(b)||(b=function(){});var c=this.schema,d={TableName:c.table,ReturnConsumedCapacity:"TOTAL",Key:{}};try{d.Key[c.hashKey]=c.serializeHashAttribute(c.getHashFromMatch(a))}catch(e){return b(e)}return c.hasRangeAttributes()?c.isValidRangeMatch(a)?(d.Key[c.rangeKey]=c.serializeRangeAttribute(c.getRangeFromMatch(a)),this.connection.client.deleteItem(d,function(a,c){if(a)return b(a);b(a,c.ConsumedCapacity.CapacityUnits)})):
c.isValidSecondaryMatch(a)?this.findOne(a,function(a,c,d){if(a)return b(a);c.destroy(function(a,c){if(a)return b(a);b(null,d+c)})}):b(Error("You must specify range or secondary attribute(s)")):this.connection.client.deleteItem(d,function(a,c){if(a)return b(a);b(a,c.ConsumedCapacity.CapacityUnits)})},parse:function(a){var b=this,c=b.schema.getSerializedAttributes(),d={};_.each(c,function(c,f){var g=a[f];g&&(f===b.schema.hashKey?_.extend(d,b.schema.deserializeHashAttribute(g)):f===b.schema.rangeKey?
_.extend(d,b.schema.deserializeRangeAttribute(g)):d[f]=c.deserializeObject(g))});return b.create(d)}};module.exports=exports=function(a){a=a||{};var b={options:a,schema:a.schema};a.client&&(b.connection={client:a.client});return _.bindAll(Object.create(Model,helper.ownProperties(b)))};
