Theodorus.Controller=Class.extend({init:function(e){_.bindAll(this,"render"),this.io=e,this.view&&this.view.setController(this)},render:function(e){var o=this;return this.view.render(function(){o.setup(),e&&e()}),this},setup:function(e){return this.view.setup(function(){e&&e()}),this}}),Theodorus.namespace("user").AccountController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.user.AccountView,this._super(e),_.bindAll(this,"openAuthenticationWindow","onAuthenticationCompleted","signout")},openAuthenticationWindow:function(e){var o=e?new Theodorus.user.SigninController(this.io):new Theodorus.user.SignupController(this.io);o.callback=this.onAuthenticationCompleted,o.view.setAsPopUp(!0),o.render()},onAuthenticationCompleted:function(e){Theodorus.onAccountLoaded(e)},signout:function(){var e=this;return $.ajax({url:"/me",type:"DELETE",success:e.onAuthenticationCompleted})}}),Theodorus.namespace("feed").AddTopicController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.feed.AddTopicView,this._super(e)},submit:function(e,o,t){var i=this;$.post(e,o,function(e){t(e),e.error||(i.view.close(),i.io.refreshFeed())})},isSlugAvailable:function(e,o){0===e.length?o({result:"slug-is-too-short"}):Topic.isSlugValid(e)?$.get("/*"+e+"/exists",function(e){o(e)}):o({result:"slug-is-invalid"})},URLPrefix:function(){var e=document.URL.match(/^http[s]?:\/\/[a-zA-Z0-9\.\-_]*(:(\d)*)?\//);return e[0]+"*"}}),Theodorus.namespace("feed").FeedController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.feed.FeedView,this._super(e),_.bindAll(this,"openAddTopicWindow","refreshTopicList","reload"),this.account=new Theodorus.user.AccountController(e),this.topics=new Theodorus.feed.TopicListController(e),this.tags=new Theodorus.feed.TagCloudController(e)},setup:function(){var e=this;this.view.setup(function(){e.account.setup(),e.topics.setup(),e.tags.setup(),e.tags.load(function(){e.topics.load()})})},openAddTopicWindow:function(){this.addTopic=new Theodorus.feed.AddTopicController(this.io),this.addTopic.view.setAsPopUp(!0),this.addTopic.render()},refreshTopicList:function(){this.topics.load()},reload:function(){this.refreshTopicList()}}),Theodorus.namespace("user").SigninController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.user.SigninView,this._super(e),this.callback=ExternalWindow.windowCallback,$.getScript("/lib/md5.js",function(){}),_.bindAll(this,"submit")},submit:function(e,o){var t=this,i=o.password;o.password=md5(i),o.md5=!0,$.post(e,o,function(e){e.error?console.error(e.error):(t.view.cancel(),t.callback(e))})}});var MIN_PASSWORD_LENGTH=3;Theodorus.namespace("user").SignupController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.user.SignupView,this._super(e),this.callback=ExternalWindow.windowCallback,$.getScript("/lib/md5.js",function(){}),_.bindAll(this,"submit")},submit:function(e,o){var t=this,i=o.password,n=o.password_repeat;return o.terms_of_use?i!=n?{error:"passwords-dont-match"}:MIN_PASSWORD_LENGTH>i.length?{error:"passwords-too-short"}:1>this.verifyPasswordComplexity(i)?{error:"passwords-too-simple"}:(o.password=md5(i),o.password_repeat=md5(n),o.md5=!0,$.post(e,o,function(e){e.error?console.error(e.error):(t.view.cancel(),t.callback(e))}),{}):{error:"terms-of-use-not-approved"}},verifyPasswordComplexity:function(e){return/(?=^.{8,}$)(?=.*\d)(?=.*\W+)(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$/.test(e)?4:/(?=^.{8,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$/.test(e)?3:/(?=^.{6,}$)(?=.*\d)(?=.*[A-Za-z]).*$/.test(e)?2:/[a-zA-Z0-9\_\-]{3,}$/i.test(e)?1:0}}),Theodorus.namespace("feed").TagCloudController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.feed.TagCloudView,this._super(e),this.collection=new Tags,e.getTagColor=this.getTagColor.bind(this),_.bindAll(this,"load","selectTag","render","getTagColor")},load:function(e){var o=this,t=function(){o.render(e)};this.collection.fetch({reset:!0,success:t,error:t})},getTagColor:function(e){var o=new Tag,t=this.collection.findWhere({tag:e});return(t?t:o).get("color")},selectTag:function(){alert("tag selection not implemented")}}),Theodorus.namespace("topic").TopicController=Theodorus.Controller.extend({topic:null,init:function(e){this.view=new Theodorus.topic.TopicView,this._super(e),_.bindAll(this,"render","load")},render:function(e){var o=this;this.topic||this.load(function(e){o.topic=404==e.status?new Notification(e):new Topic(e),e&&o.render()}),this._super(e)},load:function(e){alert("topic?"),$.get("/"+this.io.docURL,e).fail(e)}}),Theodorus.namespace("feed").TopicListController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.feed.TopicListView,this._super(e),this.isLoading=!1,this.isAllLoaded=!1,this.collection=new Topics,this.collection.setPage(1),_.bindAll(this,"load","loadCallback","openTopic")},loadCallback:function(e,o){var t=this.io,i=e.length,n=o.length;for(n||(this.isAllLoaded=!0),this.isLoading=!1;n--;){var s=e.at(i-n-1),r=s.get("initiator");if("object"==typeof r&&s.set("initiator",new User(r)),r=s.get("tags"),"object"==typeof r){var l=new Tags;for(var d in r)l.add({tag:r[d],color:t.getTagColor(r[d])});s.set("tags",l)}}this.render()},load:function(){this.isAllLoaded||this.isLoading||(this.isLoading=!0,this.collection.fetch({method:"add",success:this.loadCallback,error:this.loadCallback}))},sendFeedback:function(e,o){alert("sendFeedback?"),$.get(e,function(e){o(e?e:{error:"no-result"})})},openTopic:function(e,o,t){this.io.openPage(e,o,function(){t&&t()})},reload:function(){this.collection.setPage(1),this.isAllLoaded=!0,this.load()},nextPage:function(){!this.collection.length||this.isAllLoaded||this.isLoading||(this.collection.setPage(this.collection.getPage()+1),this.load())}}),Theodorus.namespace("feed").SearchController=Theodorus.Controller.extend({init:function(e){this.view=new Theodorus.feed.SearchView,this._super(e)}}),_.extend(Theodorus.namespace("tools.MessageController"),{hey:function(){alert("Hello!")}});