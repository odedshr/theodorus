Theodorus.View=Backbone.View.extend({xslt:null,setController:function(e){this.controller=e},setup:function(e){return this.$el=this.$el?$(this.$el.selector):null,e&&e(),this},setAsPopUp:function(e){this.isPopup=e},transform:function(e,t){var n=$,i=t;!this.isPopup&&this.$el&&(0===this.$el.size()&&(this.$el=$(this.$el.selector)),this.$el.size()>0?n=this.$el:console.log("failed to find element ("+this.$el.selector+") for \n"+e)),this.isPopup&&(i=function(e){$("#popup_placeholder").append(e),t(e)}),n.transform({async:!1,xslCache:!0,xmlstr:"<xml>"+e+"</xml>",xsl:"/ui/xslt/default.xsl",success:i,error:function(t){alert("error transforming :"+t+"\n"+e)}})},getFormFields:function(e){var t=e.elements,n={};for(var i in t){var o=t[i];o.name&&(n[o.name]="checkbox"==o.type?o.checked:o.value)}return n}}),Theodorus.namespace("user").AccountView=Theodorus.View.extend({el:"#account",initialize:function(){_.bindAll(this,"openAuthenticationWindow")},render:function(e){var t=this;return this.transform(this.controller.user(),function(){t.setup(),e&&e()}),this},setup:function(e){var t=this;return $("#btn_signup").click(this.openAuthenticationWindow),$("#btn_signin").click(this.openAuthenticationWindow),$("#btn_signout").click(function(){return!t.controller.signout()}),Theodorus.View.prototype.setup.call(this,e)},openAuthenticationWindow:function(e){return this.controller.openAuthenticationWindow("signin"==e.target.id.replace(/btn_/,"")),!1}}),Theodorus.namespace("feed").AddTopicView=Theodorus.View.extend({el:"#add_topic",initialize:function(){_.bindAll(this,"onsubmit","onSlugKeyUp","onTitleKeyUp","updateTitleCharsLeft","close","setup")},render:function(e){var t=this,n=function(n){t.setup(),e&&e(t,n)};return this.controller.io.user.can("suggest")?this.transform("<addTopic prefix='"+this.controller.URLPrefix()+"'/>",n):this.$el.html(""),this},setup:function(e){this.titleCharsleft=$("#topic_title_chars_left");var t=document.getElementById("topic_title");return this.updateTitleCharsLeft(t),t.onkeyup=this.onTitleKeyUp,document.getElementById("form_add_topic").onsubmit=this.onsubmit,document.getElementById("slug").onkeyup=this.onSlugKeyUp,document.getElementById("button_cancel").onclick=this.close,Theodorus.View.prototype.setup.call(this,e)},updateTitleCharsLeft:function(e){this.titleCharsleft.html(e.maxLength-e.value.length)},onTitleKeyUp:function(e){this.updateTitleCharsLeft(e.target)},onSlugKeyUp:function(e){var t=this;delay(function(){var n=$("#topic_slug_result");e.target.value.length>0?($("#topic_complete_slug").addClass("loading"),t.controller.isSlugAvailable(e.target.value,function(e){n.removeClass("loading"),transform(n,"<slugTest result='"+e.result+"'/>")})):n.html("")},1e3)},onsubmit:function(e){var t=this;return this.controller.io.notify("info","sending-data"),this.controller.submit(e.target.action,getFormFields(e.target),function(e){alert("here"),t.controller.io.notify("error",e.error)}),!1},close:function(){return document.getElementById("form_add_topic").remove(),!1}}),Theodorus.namespace("feed").FeedView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"openAddTopicWindow","setup","render")},render:function(e){var t=this,n=this.controller.io.user,i='<page type="feed">'+n.xml()+(n.can("suggest")?"<addTopic/>":"")+"</page>";return this.transform(i,function(n){e&&e(t,n)}),this},setup:function(e){return $("#link_suggest_topic").click(this.openAddTopicWindow),Theodorus.View.prototype.setup.call(this,e)},openAddTopicWindow:function(){return this.controller.openAddTopicWindow(),!1}}),Theodorus.namespace("user").SigninView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"render","setup","onsubmit","cancel")},render:function(e){var t=this;return console.log("render signinview 1"),this.transform("<signin />",function(n){console.log("render signinview 2"),t.controller.io.notify("info","authenticating"),console.log("render signinview 3"),t.setup(),e&&e(t,n)}),this},setup:function(e){return document.getElementById("form_signin").onsubmit=this.onsubmit,document.getElementById("button-cancel").onclick=this.cancel,Theodorus.View.prototype.setup.call(this,e)},onsubmit:function(e){var t=this.controller.io;return t.notify("info","authenticating"),this.controller.submit(e.target.action,getFormFields(e.target),function(e){t.notify("error",e.error),e.error?alert(e.error):t.openPage(t.docURL)}),!1},cancel:function(){return document.getElementById("form_signin").remove(),!1}}),Theodorus.namespace("user").SignupView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"render","setup","onsubmit","cancel")},render:function(e){var t=this;return this.transform("<signup />",function(n){t.setup(),e&&e(t,n)}),this},setup:function(e){return document.getElementById("form_signup").onsubmit=this.onsubmit,document.getElementById("button-cancel").onclick=this.cancel,Theodorus.View.prototype.setup.call(this,e)},onsubmit:function(e){try{var t=this;this.controller.io.notify("info","sending-data"),this.controller.submit(e.target.action,getFormFields(e.target),function(e){t.controller.io.notify("error",e.error)})}catch(n){alert(n)}return!1},cancel:function(){return document.getElementById("form_signup").remove(),!1}}),Theodorus.namespace("feed").TagCloudView=Theodorus.View.extend({el:"#tags",initialize:function(){},render:function(e){var t=this;return this.transform(this.controller.collection.xml(),function(n){t.setup(),e&&e(t,n)}),this},setup:function(e){return $(".tag").click(this.tagPressed.bind(this)),Theodorus.View.prototype.setup.call(this,e)},tagPressed:function(e){return this.controller.selectTag(e.target.href,e.target.innerHTML),!1}}),Theodorus.namespace("feed").TopicListView=Theodorus.View.extend({el:"#topics",window:$(window),jScroller:window,jWrapper:$(document),initialize:function(){},render:function(e){var t=this;return this.transform(this.controller.collection.xml(),function(n){t.setup(),e&&e(t,n)}),this},setup:function(e){return $(".topic .title").off("click").click(this.titlePressed.bind(this)),$(".button-action").off("click").click(this.actionPressed.bind(this)),this.jScroller.scroll(this.listScrolled.bind(this)),Theodorus.View.prototype.setup.call(this,e)},titlePressed:function(e){return this.controller.openTopic(e.target.href,e.target.innerHTML),!1},actionPressed:function(e){var t=e.target.href;return this.controller.sendFeedback(t,function(n){if(n.error)alert(n.error);else{var i=$(e.target),o=t.substr(0,t.lastIndexOf("/"))+"/"+(i.is(".pressed")?"":"un")+n.key,r=n.value;i.toggleClass("pressed").attr("href",o).children(".count").html(r>0?r:"")}}),!1},listScrolled:function(){-100>this.jScroller.scrollTop()?this.controller.reload():(this.jScroller.scrollTop()+this.jScroller.height())/this.jWrapper.height()>.86&&this.controller.nextPage()},widthChanged:function(){}}),Theodorus.namespace("topic").TopicView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"setup")},render:function(e){var t=this,n=this.controller.topic,i=this.controller.io.user,o='<page type="topicView"><url>'+encodeURI(location.href)+"</url>"+i.xml()+(n?n.xml():"<topicLoading />")+"</page>";return console.log(location.href),console.log(decodeURI(location.href)),console.log(encodeURI(location.href)),console.log(o),this.transform(o,function(n){e&&e(t,n)}),this},setup:function(e){return $("#link_suggest_topic").click(this.openAddTopicWindow),Theodorus.View.prototype.setup.call(this,e)}});