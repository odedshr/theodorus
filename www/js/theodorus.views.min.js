Theodorus.View=Backbone.View.extend({xslt:null,setController:function(t){this.controller=t},setup:function(t){return this.$el=this.$el?$(this.$el.selector):null,t&&t(),this},setAsPopUp:function(t){this.isPopup=t},transform:function(t,e){var n=$,i=e;!this.isPopup&&this.$el&&(0===this.$el.size()&&(this.$el=$(this.$el.selector)),this.$el.size()>0?n=this.$el:console.log("failed to find element ("+this.$el.selector+") for \n"+t)),this.isPopup&&(i=function(t){$("#popup_placeholder").append(t),e(t)}),n.transform({async:!1,xslCache:!0,xmlstr:"<xml>"+t+"</xml>",xsl:"/ui/xslt/default.xsl",success:i,error:function(e){alert("error transforming :"+e+"\n"+t)}})},getFormFields:function(t){var e=t.elements,n={};for(var i in e){var o=e[i];o.name&&(n[o.name]="checkbox"==o.type?o.checked:o.value)}return n}}),Theodorus.namespace("user").AccountView=Theodorus.View.extend({el:"#account",initialize:function(){_.bindAll(this,"openAuthenticationWindow")},render:function(t){var e=this;return this.transform(this.controller.user(),function(){e.setup(),t&&t()}),this},setup:function(t){var e=this;return $("#btn_signup").click(this.openAuthenticationWindow),$("#btn_signin").click(this.openAuthenticationWindow),$("#btn_signout").click(function(){return!e.controller.signout()}),Theodorus.View.prototype.setup.call(this,t)},openAuthenticationWindow:function(t){return this.controller.openAuthenticationWindow("signin"==t.target.id.replace(/btn_/,"")),!1}}),Theodorus.namespace("feed").AddTopicView=Theodorus.View.extend({el:"#add_topic",initialize:function(){_.bindAll(this,"onsubmit","onSlugKeyUp","onTitleKeyUp","updateTitleCharsLeft","close","setup")},render:function(t){var e=this,n=function(n){e.setup(),t&&t(e,n)};return this.controller.io.user.can("suggest")?this.transform("<addTopic prefix='"+this.controller.URLPrefix()+"'/>",n):this.$el.html(""),this},setup:function(t){this.titleCharsleft=$("#topic_title_chars_left");var e=document.getElementById("topic_title");return this.updateTitleCharsLeft(e),e.onkeyup=this.onTitleKeyUp,document.getElementById("form_add_topic").onsubmit=this.onsubmit,document.getElementById("slug").onkeyup=this.onSlugKeyUp,document.getElementById("button_cancel").onclick=this.close,Theodorus.View.prototype.setup.call(this,t)},updateTitleCharsLeft:function(t){this.titleCharsleft.html(t.maxLength-t.value.length)},onTitleKeyUp:function(t){this.updateTitleCharsLeft(t.target)},onSlugKeyUp:function(t){var e=this;delay(function(){var n=$("#topic_slug_result");t.target.value.length>0?($("#topic_complete_slug").addClass("loading"),e.controller.isSlugAvailable(t.target.value,function(t){n.removeClass("loading"),transform(n,"<slugTest result='"+t.result+"'/>")})):n.html("")},1e3)},onsubmit:function(t){var e=this;return this.controller.io.notify("info","sending-data"),this.controller.submit(t.target.action,getFormFields(t.target),function(t){alert("here"),e.controller.io.notify("error",t.error)}),!1},close:function(){return document.getElementById("form_add_topic").remove(),!1}}),Theodorus.namespace("feed").FeedView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"openAddTopicWindow","setup","render")},render:function(t){var e=this,n=this.controller.io.user,i='<page type="feed">'+n.xml()+(n.can("suggest")?"<addTopic/>":"")+"</page>";return this.transform(i,function(n){t&&t(e,n)}),this},setup:function(t){return $("#link_suggest_topic").click(this.openAddTopicWindow),Theodorus.View.prototype.setup.call(this,t)},openAddTopicWindow:function(){return this.controller.openAddTopicWindow(),!1}}),Theodorus.namespace("user").SigninView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"render","setup","onsubmit","cancel")},render:function(t){var e=this;return this.transform("<signin />",function(n){e.setup(),t&&t(e,n)}),this},setup:function(t){return document.getElementById("form_signin").onsubmit=this.onsubmit,document.getElementById("button-cancel").onclick=this.cancel,Theodorus.View.prototype.setup.call(this,t)},onsubmit:function(t){var e=this;return this.controller.io.notify("info","authenticating"),this.controller.submit(t.target.action,getFormFields(t.target),function(t){e.controller.io.notify("error",t.error)}),!1},cancel:function(){return document.getElementById("form_signin").remove(),!1}}),Theodorus.namespace("user").SignupView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"render","setup","onsubmit","cancel")},render:function(t){var e=this;return this.transform("<signup />",function(n){e.setup(),t&&t(e,n)}),this},setup:function(t){return document.getElementById("form_signup").onsubmit=this.onsubmit,document.getElementById("button-cancel").onclick=this.cancel,Theodorus.View.prototype.setup.call(this,t)},onsubmit:function(t){try{var e=this;this.controller.io.notify("info","sending-data"),this.controller.submit(t.target.action,getFormFields(t.target),function(t){e.controller.io.notify("error",t.error)})}catch(n){alert(n)}return!1},cancel:function(){return document.getElementById("form_signup").remove(),!1}}),Theodorus.namespace("feed").TagCloudView=Theodorus.View.extend({el:"#tags",initialize:function(){},render:function(t){var e=this;return this.transform(this.controller.collection.xml(),function(n){e.setup(),t&&t(e,n)}),this},setup:function(t){return $(".tag").click(this.tagPressed.bind(this)),Theodorus.View.prototype.setup.call(this,t)},tagPressed:function(t){return this.controller.selectTag(t.target.href,t.target.innerHTML),!1}}),Theodorus.namespace("feed").TopicListView=Theodorus.View.extend({el:"#topics",jScroller:$(window),jWrapper:$(document),initialize:function(){},render:function(t){var e=this;return this.transform(this.controller.collection.xml(),function(n){e.setup(),t&&t(e,n)}),this},setup:function(t){return $(".topic .title").off("click").click(this.titlePressed.bind(this)),$(".button-action").off("click").click(this.actionPressed.bind(this)),this.jScroller.scroll(this.listScrolled.bind(this)),Theodorus.View.prototype.setup.call(this,t)},titlePressed:function(t){return this.controller.openTopic(t.target.href,t.target.innerHTML),!1},actionPressed:function(t){var e=t.target.href;return this.controller.sendFeedback(e,function(n){if(n.error)alert(n.error);else{var i=$(t.target),o=e.substr(0,e.lastIndexOf("/"))+"/"+(i.is(".pressed")?"":"un")+n.key,r=n.value;i.toggleClass("pressed").attr("href",o).children(".count").html(r>0?r:"")}}),!1},listScrolled:function(){-100>this.jScroller.scrollTop()?this.controller.reload():(this.jScroller.scrollTop()+this.jScroller.height())/this.jWrapper.height()>.86&&this.controller.nextPage()}}),Theodorus.namespace("topic").TopicView=Theodorus.View.extend({el:"#main",initialize:function(){_.bindAll(this,"setup")},render:function(t){var e=this,n=this.controller.topic,i=this.controller.io.user,o='<page type="topicView">'+i.xml()+(n?n.xml():"<topicLoading />")+"</page>";return console.log(o),this.transform(o,function(n){t&&t(e,n)}),this},setup:function(t){return $("#link_suggest_topic").click(this.openAddTopicWindow),Theodorus.View.prototype.setup.call(this,t)}});