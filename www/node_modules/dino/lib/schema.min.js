var _=require("underscore"),connection=require("./connection"),helper=require("./helper"),methods={createTable:function(a,b){1===arguments.length?_.isFunction(a)&&(b=a,a={}):0===arguments.length&&(a={},b=function(){});var c=this,d={TableName:c.table,ProvisionedThroughput:{ReadCapacityUnits:a.readUnits||1,WriteCapacityUnits:a.writeUnits||1},AttributeDefinitions:[{AttributeName:c.hashKey,AttributeType:c.get(c.hashKey).key}],KeySchema:[{AttributeName:c.hashKey,KeyType:"HASH"}]},e=a.client||connection.client;
c.hasRangeAttributes()&&(d.AttributeDefinitions.push({AttributeName:c.rangeKey,AttributeType:c.get(c.rangeKey).key}),d.KeySchema.push({AttributeName:c.rangeKey,KeyType:"RANGE"}));c.hasSecondaryAttributes()&&(d.LocalSecondaryIndexes=[],_.each(c.secondaryKeyAttributes,function(a){d.AttributeDefinitions.push({AttributeName:a,AttributeType:c.get(a).key});d.LocalSecondaryIndexes.push({IndexName:c.table+"."+a,KeySchema:[{AttributeName:c.hashKey,KeyType:"HASH"},{AttributeName:a,KeyType:"RANGE"}],Projection:{ProjectionType:"KEYS_ONLY"}})}));
e.createTable(d,function(a){if(a)return b(a);b(null)})},add:function(a,b){var c,d;if(null===a||void 0===a)return this;"object"===typeof a?d=a:(d={})[a]=b;for(c in d)this.attributes[c]=Object.create(d[c]);return this},get:function(a){return this.attributes[a]},serializeKeyAttribute:function(a,b){var c=this;if(!_.isArray(a))return c.get(b[0]).serializeObject(a);var d=_.map(b,function(b,d){return c.get(b).serialize(a[d])}).join(c.keyDelimiter);switch(typeof a[0]){case "number":return{N:d};case "string":return{S:d};
case "date":return{D:d};case "boolean":return{B:d};default:return{O:d}}},serializeHashAttribute:function(a){return this.serializeKeyAttribute(a,this.hashKeyAttributes)},serializeRangeAttribute:function(a){return this.serializeKeyAttribute(a,this.rangeKeyAttributes)},deserializeKeyAttribute:function(a,b){var c=this,d={};if(a.S)a=1<b.length?a.S.split(c.keyDelimiter):[a.S];else for(key in a){a=[a[key]];break}_.each(b,function(b,h){d[b]=c.get(b).deserialize(a[h])});return d},deserializeHashAttribute:function(a){return this.deserializeKeyAttribute(a,
this.hashKeyAttributes)},deserializeRangeAttribute:function(a){return this.deserializeKeyAttribute(a,this.rangeKeyAttributes)},getSerializedAttributes:function(){var a=_.clone(this.attributes);1<this.hashKeyAttributes.length&&(_.each(this.hashKeyAttributes,function(b){delete a[b]}),a[this.hashKey]={});_.isArray(this.rangeKeyAttributes)&&1<this.rangeKeyAttributes.length&&(_.each(this.rangeKeyAttributes,function(b){delete a[b]}),a[this.rangeKey]={});return a},generateQueryParams:function(a){if(_.isEmpty(a))throw Error("You must specify query attribute(s)");
var b=this,c={TableName:b.table,ReturnConsumedCapacity:"TOTAL",ScanIndexForward:!1,KeyConditions:{}},d=0,e={},h=0,f={},g;_.each(a,function(a,c){if(0<=b.hashKeyAttributes.indexOf(c))return d++,e[c]=a;if(0<=b.rangeKeyAttributes.indexOf(c))return h++,f[c]=a;if(0<=b.secondaryKeyAttributes.indexOf(c))return g=c});if(d!==b.hashKeyAttributes.length)throw Error("You must specify attribute(s): "+b.hashKeyAttributes.join(", "));e=_.map(e,function(a){return a});c.KeyConditions[b.hashKey]={AttributeValueList:[b.serializeHashAttribute(1<
e.length?e:e[0])],ComparisonOperator:"EQ"};if(0<h){if(h!==b.rangeKeyAttributes.length)throw Error("You must specify attribute(s): "+b.rangeKeyAttributes.join(", "));f=_.map(f,function(a){return a});c.KeyConditions[b.rangeKey]={AttributeValueList:[b.serializeRangeAttribute(1<f.length?f:f[0])],ComparisonOperator:"EQ"};return c}g&&(c.KeyConditions[g]={AttributeValueList:[b.serializeKeyAttribute(a[g],[g])],ComparisonOperator:"EQ"},c.IndexName=b.table+"."+g,c.ScanIndexForward=!1,c.Select="ALL_ATTRIBUTES");
return c},validateKeyMatch:function(a,b,c){if(_.isEmpty(a))throw Error("You must specify attributes");var d=0;for(attr in a)0<=b.indexOf(attr)&&d++;if(!(c&&0<d)&&d!==b.length)throw Error("You must specify attribute(s): "+b.join(", "));},validateHashMatch:function(a){this.validateKeyMatch(a,this.hashKeyAttributes)},validateRangeMatch:function(a){this.validateKeyMatch(a,this.rangeKeyAttributes)},validateSecondaryMatch:function(a){this.validateKeyMatch(a,this.secondaryKeyAttributes,!0)},isValidRangeMatch:function(a){try{this.validateRangeMatch(a)}catch(b){return!1}return!0},
isValidSecondaryMatch:function(a){try{this.validateSecondaryMatch(a)}catch(b){return!1}return!0},getValFromMatch:function(a,b){var c=[];for(attr in a)0<=b.indexOf(attr)&&c.push(a[attr]);return c},getHashFromMatch:function(a){return this.getValFromMatch(a,this.hashKeyAttributes)},getRangeFromMatch:function(a){return this.getValFromMatch(a,this.rangeKeyAttributes)},hasRangeAttributes:function(){return _.isArray(this.rangeKeyAttributes)&&0<this.rangeKeyAttributes.length},hasSecondaryAttributes:function(){return _.isArray(this.secondaryKeyAttributes)&&
0<this.secondaryKeyAttributes.length}};module.exports=exports=function(a){a=a||{};a.key=a.key||{hash:"",range:null};var b=a.keyDelimiter||"#",c=helper.normalizeKey(a.key.hash),d=helper.normalizeKey(a.key.range),e=helper.normalizeKey(a.key.secondary),b=helper.ownProperties({attributes:{},table:a.table||"",hashKeyAttributes:c,rangeKeyAttributes:d,secondaryKeyAttributes:e,hashKey:c.join(b),rangeKey:d?d.join(b):null,keyDelimiter:b});return _.bindAll(Object.create(methods,b).add(a.attributes))};
